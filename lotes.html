<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lotes ‚Äî Importaciones</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">üì¶</div>
    <div>
      <h1>Lotes (Importaci√≥n Guatemala)</h1>
      <div class="small">Registra piezas, aduana y compra total en quetzales. El sistema calcula inversi√≥n por lote.</div>
    </div>
  </div>

  <nav class="nav">
    <a href="index.html">Inicio</a>
    <a href="config.html">Config</a>
    <a class="active" href="lotes.html">Lotes</a>
    <a href="inventario.html">Inventario</a>
    <a href="ventas.html">Ventas</a>
    <a href="gastos.html">Gastos</a>
    <a href="reportes.html">Reportes</a>
  </nav>
</header>

<main>
  <section class="card">
    <h2>üëã C√≥mo funciona un lote</h2>
    <div class="small">
      ‚Ä¢ Un lote representa una compra/ingreso de mercanc√≠a desde Guatemala.<br/>
      ‚Ä¢ La <b>aduana total (USD)</b> se prorratea entre las piezas del lote.<br/>
      ‚Ä¢ La <b>compra total (Q)</b> se convierte a USD con el tipo de cambio.<br/>
      ‚Ä¢ <b>Inversi√≥n del lote</b> = compra(Q‚Üí$) + aduana(USD). Esto alimenta el indicador global de recuperaci√≥n.
    </div>
  </section>

  <section class="grid cols2">
    <div class="card">
      <h2>‚ûï Crear lote</h2>

      <label>Fecha del lote</label>
      <input id="date" type="date"/>

      <div class="grid cols2" style="margin-top:12px">
        <div>
          <label>Total de piezas</label>
          <input id="qty" type="number" step="1" placeholder="60"/>
        </div>
        <div>
          <label>Aduana total (USD)</label>
          <input id="customsTotal" type="number" step="0.01" placeholder="80.00"/>
        </div>
      </div>

      <label>Compra total del lote (Q)</label>
      <input id="purchaseTotalQ" type="number" step="0.01" placeholder="5000.00"/>
      <div class="small muted">Monto total gastado en Guatemala (solo compra). Se convierte a d√≥lares con FX.</div>

      <label>Tipo de cambio (Q ‚Üí $)</label>
      <input id="fx" type="number" step="0.01" placeholder="7.50"/>
      <div class="small muted">Se llena desde Config, pero puedes registrar el FX espec√≠fico de este lote.</div>

      <div class="flex" style="margin-top:12px">
        <button class="btn primary" id="btnAdd">Guardar lote</button>
        <span class="small" id="preview"></span>
      </div>

      <hr/>
      <div class="small muted">
        Consejo: registra la compra total del lote (Q) para medir recuperaci√≥n real. Si no la registras, la inversi√≥n quedar√° incompleta.
      </div>
    </div>

    <div class="card">
      <h2>üí° Lo que te va a dar el sistema</h2>
      <div class="small" id="tips"></div>
      <hr/>
      <div class="small muted">
        Tip: Si tu aduana fue un monto fijo, el prorrateo por pieza te dir√° cu√°nto ‚Äúcarga‚Äù cada prenda.
      </div>
    </div>
  </section>

  <section class="card">
    <div class="flex" style="justify-content:space-between">
      <h2 style="margin:0">üìã Lista de lotes</h2>
      <div class="flex">
        <button class="btn" id="btnExportLots">Exportar lotes</button>
      </div>
    </div>

    <div class="small muted" style="margin-top:6px">
      Aqu√≠ puedes ver inversi√≥n del lote y aduana/pieza. La recuperaci√≥n se ve en Reportes.
    </div>

    <div style="overflow:auto;margin-top:10px">
      <table>
        <thead>
          <tr>
            <th>Lote</th>
            <th>Aduana</th>
            <th>Compra</th>
            <th>Inversi√≥n</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<script src="app.js"></script>
<script>
  const db = loadDB();

  const date = document.getElementById("date");
  const qty = document.getElementById("qty");
  const customsTotal = document.getElementById("customsTotal");
  const purchaseTotalQ = document.getElementById("purchaseTotalQ");
  const fx = document.getElementById("fx");
  const preview = document.getElementById("preview");
  const tipsBox = document.getElementById("tips");
  const tbody = document.getElementById("tbody");

  date.value = new Date().toISOString().slice(0,10);
  fx.value = db.config.fx ?? 7.5;

  function updatePreview(){
    const q = Math.max(1, Math.floor(num(qty.value) || 1));
    const customs = num(customsTotal.value);
    const per = customs / q;

    const _fx = num(fx.value || db.config.fx || 7.5);
    const buyQ = num(purchaseTotalQ.value);
    const buyUSD = buyQ / _fx;

    const inv = buyUSD + customs;

    preview.innerHTML = `
      Aduana/pza: <b>${money(per)}</b>
      <span class="muted">¬∑ Compra $${buyUSD.toFixed(2)} + Aduana ${money(customs)} =</span>
      <b>${money(inv)}</b>
    `;
  }

  [qty, customsTotal, purchaseTotalQ, fx].forEach(el => el.addEventListener("input", updatePreview));
  updatePreview();

  function renderTips(){
    const t = [];
    t.push("‚Ä¢ Crea el lote antes de ingresar prendas, para que el costo de aduana/pieza sea autom√°tico.");
    t.push("‚Ä¢ Si el FX var√≠a, guarda el FX del lote para una inversi√≥n m√°s precisa.");
    t.push("‚Ä¢ La recuperaci√≥n se calcula con prendas Retirado/Depositado y se compara con la inversi√≥n del lote.");
    tipsBox.innerHTML = t.join("<br/>");
  }

  document.getElementById("btnAdd").addEventListener("click", ()=>{
    const q = Math.max(1, Math.floor(num(qty.value) || 0));
    if(q <= 0){
      alert("Ingresa el total de piezas del lote.");
      return;
    }

    const lot = {
      id: uid("LOT"),
      date: date.value || new Date().toISOString().slice(0,10),
      qty: q,
      customsTotal: num(customsTotal.value),
      purchaseTotalQ: num(purchaseTotalQ.value), // ‚úÖ NUEVO
      fx: num(fx.value || db.config.fx || 7.5)   // FX espec√≠fico del lote
    };

    db.lots.unshift(lot);
    saveDB(db);

    // reset
    date.value = new Date().toISOString().slice(0,10);
    qty.value = "";
    customsTotal.value = "";
    purchaseTotalQ.value = "";
    fx.value = db.config.fx ?? 7.5;

    updatePreview();
    render();
  });

  function deleteLot(id){
    // Si hay prendas con ese lote, evita borrado accidental
    const used = db.items.some(it => it.lotId === id);
    if(used){
      alert("No puedes eliminar este lote porque hay prendas asociadas. Primero elimina o reasigna esas prendas.");
      return;
    }
    if(!confirm("¬øEliminar este lote?")) return;
    db.lots = db.lots.filter(l => l.id !== id);
    saveDB(db);
    render();
  }
  window.deleteLot = deleteLot;

  function editLot(id){
    const lot = db.lots.find(l => l.id === id);
    if(!lot) return;

    const newQty = prompt("Total de piezas:", String(lot.qty || 1));
    if(newQty === null) return;

    const newCustoms = prompt("Aduana total (USD):", String(lot.customsTotal || 0));
    if(newCustoms === null) return;

    const newBuyQ = prompt("Compra total (Q):", String(lot.purchaseTotalQ || 0));
    if(newBuyQ === null) return;

    const newFx = prompt("FX del lote (Q‚Üí$):", String(lot.fx || db.config.fx || 7.5));
    if(newFx === null) return;

    lot.qty = Math.max(1, Math.floor(num(newQty) || 1));
    lot.customsTotal = num(newCustoms);
    lot.purchaseTotalQ = num(newBuyQ);
    lot.fx = num(newFx);

    saveDB(db);
    render();
  }
  window.editLot = editLot;

  function renderTable(){
    tbody.innerHTML = "";

    if(db.lots.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="5" class="small muted">No hay lotes todav√≠a.</td>`;
      tbody.appendChild(tr);
      return;
    }

    db.lots.forEach(l=>{
      const q = Math.max(1, Math.floor(num(l.qty) || 1));
      const per = num(l.customsTotal) / q;

      const fxLot = num(l.fx || db.config.fx || 7.5);
      const buyUSD = num(l.purchaseTotalQ || 0) / fxLot;
      const inv = lotInvestmentUSD(db, l);

      const d = new Date(l.date+"T00:00:00").toLocaleDateString("es-SV");

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <div><b>${d}</b></div>
          <div class="small muted">${l.qty} pcs ¬∑ FX ${fxLot.toFixed(2)}</div>
        </td>
        <td class="small">
          <div><span class="muted">Total:</span> <b>${money(l.customsTotal)}</b></div>
          <div><span class="muted">Por pieza:</span> <b>${money(per)}</b></div>
        </td>
        <td class="small">
          <div><span class="muted">Compra:</span> Q${num(l.purchaseTotalQ||0).toFixed(2)}</div>
          <div><span class="muted">Compra USD:</span> <b>${money(buyUSD)}</b></div>
        </td>
        <td class="small">
          <div><span class="muted">Inversi√≥n lote:</span></div>
          <div><b>${money(inv)}</b></div>
        </td>
        <td>
          <div class="flex">
            <button class="btn" onclick="editLot('${l.id}')">Editar</button>
            <button class="btn bad" onclick="deleteLot('${l.id}')">Eliminar</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  document.getElementById("btnExportLots").addEventListener("click", ()=>{
    const payload = { lots: db.lots, exportedAt: new Date().toISOString() };
    exportJSON("lotes_export.json", payload);
  });

  function render(){
    renderTips();
    renderTable();
  }

  render();
</script>
</body>
</html>
