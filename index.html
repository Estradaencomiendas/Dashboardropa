<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel â€” Control de negocio</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">ğŸ§ </div>
    <div>
      <h1>Panel (Control general)</h1>
      <div class="small">InversiÃ³n, recuperaciÃ³n, stock, reservados, retirados, utilidad (bruta vs neta).</div>
    </div>
  </div>

  <nav class="nav">
    <a class="active" href="index.html">Inicio</a>
    <a href="config.html">Config</a>
    <a href="lotes.html">Lotes</a>
    <a href="inventario.html">Inventario</a>
    <a href="ventas.html">Ventas</a>
    <a href="gastos.html">Gastos</a>
    <a href="reportes.html">Reportes</a>
  </nav>
</header>

<main>
  <section class="card">
    <h2>ğŸ‘‹ CÃ³mo usar el sistema (visiÃ³n rÃ¡pida)</h2>
    <div class="small">
      â€¢ Primero crea un <b>lote</b> (piezas, aduana total, compra total en Q).<br/>
      â€¢ Luego crea <b>prendas</b> en Inventario vinculadas al lote (costo Q).<br/>
      â€¢ En Ventas, mueve estados hasta <b>Retirado</b> y luego <b>Depositado</b> para cuadrar caja.<br/>
      â€¢ En Reportes verÃ¡s <b>canales</b>, <b>rotaciÃ³n</b>, <b>recuperaciÃ³n por lote</b> y recomendaciones.
    </div>
  </section>

  <section class="grid cols3">
    <div class="card">
      <h2>ğŸ’° RecuperaciÃ³n global (meta: recuperar inversiÃ³n)</h2>
      <div id="recoveryBox" class="small"></div>
      <hr/>
      <div class="small muted">
        Regla: cuando <b>Recuperado</b> supere <b>InversiÃ³n</b>, el sistema lo muestra en verde. Antes de eso, en rojo.
      </div>
    </div>

    <div class="card">
      <h2>ğŸ“¦ OperaciÃ³n</h2>
      <div id="opsBox" class="small"></div>
      <hr/>
      <div class="small muted">
        â€œReservadoâ€ no es dinero. â€œRetiradoâ€ sÃ­ cuenta como venta real.
      </div>
    </div>

    <div class="card">
      <h2>ğŸ“Œ Alertas</h2>
      <div id="alerts" class="small"></div>
      <hr/>
      <div class="small muted">
        Si ves â€œNo retiradoâ€ alto en un canal, conviene confirmar antes de enviar.
      </div>
    </div>
  </section>

  <section class="card" style="margin-top:12px">
    <h2>ğŸ“Š Resumen rÃ¡pido</h2>
    <div class="kpis" id="kpis"></div>
  </section>

  <section class="grid cols2" style="margin-top:12px">
    <div class="card">
      <h2>âœ… Accesos rÃ¡pidos</h2>
      <div class="flex">
        <a class="btn primary" href="lotes.html">+ Crear lote</a>
        <a class="btn primary" href="inventario.html">+ Agregar prenda</a>
        <a class="btn primary" href="ventas.html">Gestionar ventas</a>
        <a class="btn" href="reportes.html">Ver reportes</a>
      </div>
      <hr/>
      <div class="small muted">
        Consejo: si hoy es miÃ©rcoles o sÃ¡bado, revisa Ventas para marcar Depositado y cuadrar caja.
      </div>
    </div>

    <div class="card">
      <h2>ğŸ§¾ Exportar respaldo</h2>
      <div class="small muted">
        Respalda tu base (LocalStorage). Si cambias de PC o limpias el navegador, puedes perderlo. Exporta a menudo.
      </div>
      <hr/>
      <div class="flex">
        <button class="btn" id="btnExportAll">Exportar TODO (JSON)</button>
      </div>
    </div>
  </section>
</main>

<script src="app.js"></script>
<script>
  const db = loadDB();

  function kpisCompute(db){
    const stock = db.items.filter(x=>x.status==="En stock").length;
    const reserved = db.items.filter(x=>x.status==="Reservado/Vendido").length;
    const noRet = db.items.filter(x=>x.status==="No retirado").length;
    const reenvio = db.items.filter(x=>x.status==="ReenvÃ­o").length;
    const retirado = db.items.filter(x=>x.status==="Retirado").length;
    const depositado = db.items.filter(x=>x.status==="Depositado").length;

    const sales = db.items.filter(x=>isSaleReal(x.status));
    const revenue = sales.reduce((a,x)=>a+num(x.salePrice),0);
    const profitBruta = sales.reduce((a,x)=>a+calcProfit(db,x).profit,0);

    const expenses = db.expenses.reduce((a,x)=>a+num(x.amount),0);
    const profitNeta = profitBruta - expenses;

    return { stock, reserved, noRet, reenvio, retirado, depositado, revenue, profitBruta, expenses, profitNeta };
  }

  // --- RecuperaciÃ³n global ---
  const inv = globalInvestmentUSD(db);
  const rec = globalRecoveryUSD(db);
  const diff = globalNetAfterInvestment(db);

  const recPill = diff >= 0 ? "ok" : "bad";
  const recLabel = diff >= 0 ? `âœ… Ya recuperaste +${money(diff)}` : `âš ï¸ Faltan ${money(Math.abs(diff))} por recuperar`;

  document.getElementById("recoveryBox").innerHTML = `
    <div class="flex">
      <span class="pill info">InversiÃ³n</span> <b>${money(inv)}</b>
    </div>
    <div class="flex" style="margin-top:10px">
      <span class="pill info">Recuperado</span> <b>${money(rec)}</b>
    </div>
    <div class="flex" style="margin-top:10px">
      <span class="pill ${recPill}">Balance</span> <b>${recLabel}</b>
    </div>
  `;

  // --- OperaciÃ³n ---
  const k = kpisCompute(db);
  document.getElementById("opsBox").innerHTML = `
    â€¢ Stock: <b>${k.stock}</b><br/>
    â€¢ Reservados: <b>${k.reserved}</b><br/>
    â€¢ ReenvÃ­os: <b>${k.reenvio}</b><br/>
    â€¢ No retirado: <b>${k.noRet}</b><br/>
    â€¢ Retirados (sin depositar): <b>${k.retirado}</b><br/>
    â€¢ Depositados: <b>${k.depositado}</b>
  `;

  // --- Alertas ---
  const alerts = [];
  if(k.noRet >= 5) alerts.push(`<span class="pill bad">No retirado alto</span> ${k.noRet} casos: estÃ¡s perdiendo costo interno.`);
  if(k.reserved >= 10) alerts.push(`<span class="pill warn">Reservados altos</span> ${k.reserved} casos: dale seguimiento para que no se enfrÃ­en.`);
  if(k.stock >= 40) alerts.push(`<span class="pill info">Stock alto</span> ${k.stock} en stock: probablemente conviene promociÃ³n.`);
  if(k.retirado >= 8) alerts.push(`<span class="pill warn">Pendiente depÃ³sito</span> ${k.retirado} retirados sin depositar.`);

  document.getElementById("alerts").innerHTML = alerts.length
    ? alerts.join("<br/><br/>")
    : `<span class="pill ok">OK</span> Sin alertas crÃ­ticas detectadas.`;

  // --- KPIs Cards ---
  const kpisEl = document.getElementById("kpis");
  kpisEl.innerHTML = `
    <div class="kpi">
      <div class="t">Ventas reales (Retirado+)</div>
      <div class="v">${money(k.revenue)}</div>
      <div class="s">Total de ventas reales acumuladas</div>
    </div>
    <div class="kpi">
      <div class="t">Utilidad bruta</div>
      <div class="v">${money(k.profitBruta)}</div>
      <div class="s">Venta âˆ’ (compra+aduana+mariita+noRet)</div>
    </div>
    <div class="kpi">
      <div class="t">Gastos generales</div>
      <div class="v">${money(k.expenses)}</div>
      <div class="s">Gasolina, bolsas, etiquetas, publicidadâ€¦</div>
    </div>
    <div class="kpi">
      <div class="t">Utilidad neta</div>
      <div class="v">${money(k.profitNeta)}</div>
      <div class="s">Utilidad bruta âˆ’ gastos</div>
    </div>
  `;

  // --- Export completo ---
  document.getElementById("btnExportAll").addEventListener("click", ()=>{
    const payload = {
      exportedAt: new Date().toISOString(),
      config: db.config,
      lots: db.lots,
      items: db.items,
      expenses: db.expenses
    };
    exportJSON("tienda_export_completo.json", payload);
  });
</script>
</body>
</html>

