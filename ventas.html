<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ventas ‚Äî Flujo por Encomienda</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">üí∏</div>
    <div>
      <h1>Ventas (Flujo por encomienda)</h1>
      <div class="small">Vendido ‚â† dinero. Retirado = venta real. Depositado = caja confirmada (Mi√©/S√°b).</div>
    </div>
  </div>

  <nav class="nav">
    <a href="index.html">Inicio</a>
    <a href="config.html">Config</a>
    <a href="lotes.html">Lotes</a>
    <a href="inventario.html">Inventario</a>
    <a class="active" href="ventas.html">Ventas</a>
    <a href="gastos.html">Gastos</a>
    <a href="reportes.html">Reportes</a>
  </nav>
</header>

<main>
  <section class="card">
    <h2>üëã C√≥mo usar esta pantalla (paso a paso)</h2>
    <div class="small">
      1) Cuando alguien aparta una prenda: marca <b>Reservado/Vendido</b> y elige el <b>canal</b> (FB/IG/TikTok).<br/>
      2) Si el cliente NO pasa a retirar: marca <b>No retirado</b> y elige <b>Destino fijo</b> ($1) o <b>Personalizado</b> ($3).<br/>
      3) Si el cliente pide segunda vuelta: marca <b>Reenv√≠o</b>.<br/>
      4) Cuando el cliente ya retir√≥: marca <b>Retirado</b>. Aqu√≠ ya cuenta como venta real.<br/>
      5) Cuando tu trabajadora deposita (Mi√©rcoles/S√°bado): marca <b>Depositado</b> para que cuadre con caja.
    </div>
  </section>

  <section class="grid cols2">
    <div class="card">
      <h2>üìå Conciliaci√≥n r√°pida (lo que debe cuadrar)</h2>
      <div class="small muted">
        ‚Ä¢ <b>Retirados sin depositar</b> = dinero ‚Äúpor depositar‚Äù (pendiente).<br/>
        ‚Ä¢ <b>Depositados</b> = caja confirmada.
      </div>
      <hr/>
      <div class="small" id="recon"></div>
    </div>

    <div class="card">
      <h2>üí° Consejos</h2>
      <div class="small" id="tips"></div>
      <hr/>
      <div class="small muted">
        Tip operativo: si un canal tiene mucho ‚ÄúNo retirado‚Äù, considera confirmar por mensaje antes de enviar o filtrar clientes.
      </div>
    </div>
  </section>

  <section class="card">
    <div class="flex" style="justify-content:space-between">
      <h2 style="margin:0">üìã Lista operativa (ventas)</h2>
      <div class="flex">
        <select id="filterStatus">
          <option value="">Todos los estados</option>
        </select>
        <select id="filterChannel">
          <option value="">Todos los canales</option>
          <option>Facebook</option>
          <option>Instagram</option>
          <option>TikTok</option>
        </select>
        <input id="search" placeholder="Buscar (tipo, sku)..." style="width:240px"/>
      </div>
    </div>

    <div class="small muted" style="margin-top:6px">
      Aqu√≠ mueves estados y el sistema calcula costos y utilidad por prenda (incluye aduana/lote + Mariita + penalizaci√≥n No retirado).
    </div>

    <div style="overflow:auto;margin-top:10px">
      <table>
        <thead>
          <tr>
            <th>Prenda</th>
            <th>Canal / Venta</th>
            <th>Costos</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<script src="app.js"></script>
<script>
  const db = loadDB();

  const tbody = document.getElementById("tbody");
  const filterStatus = document.getElementById("filterStatus");
  const filterChannel = document.getElementById("filterChannel");
  const search = document.getElementById("search");

  const tipsBox = document.getElementById("tips");
  const reconBox = document.getElementById("recon");

  // Fill status filter
  STATUS.forEach(s=>{
    const op = document.createElement("option");
    op.value = s;
    op.textContent = s;
    filterStatus.appendChild(op);
  });

  function fmtDate(d){
    if(!d) return "‚Äî";
    return new Date(d + "T00:00:00").toLocaleDateString("es-SV");
  }

  function pillForStatus(s){
    const map = {
      "En stock":"info",
      "Reservado/Vendido":"warn",
      "No retirado":"bad",
      "Reenv√≠o":"warn",
      "Retirado":"ok",
      "Depositado":"ok"
    };
    return `<span class="pill ${map[s] || "info"}">${s}</span>`;
  }

  function filteredItems(){
    const st = filterStatus.value;
    const ch = filterChannel.value;
    const q = (search.value || "").trim().toLowerCase();

    return db.items.filter(it=>{
      if(st && it.status !== st) return false;
      if(ch && it.channel !== ch) return false;
      if(q){
        const hay = `${it.type} ${it.sku||""}`.toLowerCase();
        if(!hay.includes(q)) return false;
      }
      return true;
    });
  }

  function renderTips(){
    const t = [];

    const reserved = db.items.filter(x=>x.status==="Reservado/Vendido").length;
    const noRet = db.items.filter(x=>x.status==="No retirado").length;
    const retirados = db.items.filter(x=>x.status==="Retirado").length;

    if(reserved>0) t.push(`‚Ä¢ Tienes <b>${reserved}</b> reservados: no cuentan como dinero.`);
    if(noRet>0) t.push(`‚Ä¢ Hay <b>${noRet}</b> ‚ÄúNo retirado‚Äù: se aplicar√° costo interno ($1 o $3).`);
    if(retirados>0) t.push(`‚Ä¢ Hay <b>${retirados}</b> retirados sin depositar: revisa mi√©rcoles/s√°bado.`);

    // canal no retirado
    const noRetByCh = {};
    db.items.filter(x=>x.status==="No retirado" && x.channel).forEach(x=>{
      noRetByCh[x.channel] = (noRetByCh[x.channel]||0)+1;
    });
    const worst = Object.entries(noRetByCh).sort((a,b)=>b[1]-a[1])[0];
    if(worst) t.push(`‚Ä¢ Canal con m√°s No retirado: <b>${worst[0]}</b> (${worst[1]}). Considera confirmaci√≥n previa.`);

    if(t.length===0) t.push("‚Ä¢ ‚úÖ Todo se ve ordenado. Mant√©n actualizado Retirado/Depositado para que caja cuadre.");

    tipsBox.innerHTML = t.join("<br/>");
  }

  function renderRecon(){
    const retirados = db.items.filter(x=>x.status==="Retirado");
    const depositados = db.items.filter(x=>x.status==="Depositado");

    const totalRet = retirados.reduce((a,x)=>a+num(x.salePrice),0);
    const totalDep = depositados.reduce((a,x)=>a+num(x.salePrice),0);

    const pend = retirados.length;
    const dep = depositados.length;

    reconBox.innerHTML = `
      <div class="flex">
        <span class="pill warn">Retirados sin depositar</span>
        <b>${pend}</b> prendas ¬∑ total ‚âà <b>${money(totalRet)}</b>
      </div>
      <div class="flex" style="margin-top:10px">
        <span class="pill ok">Depositados</span>
        <b>${dep}</b> prendas ¬∑ total ‚âà <b>${money(totalDep)}</b>
      </div>
      <hr/>
      <div class="small muted">
        Consejo: marca ‚ÄúDepositado‚Äù solo cuando tu trabajadora ya deposit√≥. As√≠ se mantiene una conciliaci√≥n real.
      </div>
    `;
  }

  function setStatus(id, next){
    const it = db.items.find(x=>x.id===id);
    if(!it) return;

    const today = new Date().toISOString().slice(0,10);

    // ---- transitions with required data ----
    if(next === "Reservado/Vendido"){
      const ch = prompt("Canal de venta: Facebook / Instagram / TikTok", it.channel || "Facebook");
      if(!ch) return;
      it.channel = ch;
      it.dates.reserved = today;
      it.status = next;
    }

    if(next === "No retirado"){
      // require channel to know where it came from
      if(!it.channel){
        const ch = prompt("Canal de venta (para medir demanda): Facebook / Instagram / TikTok", "Facebook");
        if(!ch) return;
        it.channel = ch;
      }
      const type = prompt("Tipo de NO retirado: escribe 'Destino fijo' o 'Personalizado'", it.noRetType || "Destino fijo");
      if(!type) return;
      it.noRetType = (type.toLowerCase().includes("pers")) ? "Personalizado" : "Destino fijo";
      it.dates.noRetirado = today;
      it.status = next;
    }

    if(next === "Reenv√≠o"){
      it.dates.reenvio = today;
      it.status = next;
    }

    if(next === "Retirado"){
      // ensure channel and price
      if(!it.channel){
        const ch = prompt("Canal de venta: Facebook / Instagram / TikTok", "Facebook");
        if(!ch) return;
        it.channel = ch;
      }
      if(!it.salePrice || num(it.salePrice) <= 0){
        const sp = prompt("Precio de venta ($):", String(it.suggestedPrice || it.salePrice || ""));
        if(sp === null) return;
        it.salePrice = num(sp);
      }

      // Mariita cost fixed
      const defaultMariita = (num(db.config.mariitaFixed) || 0);
      const mc = prompt("Costo fijo Mariita ($) por esta ayuda/prenda:", String(it.mariitaCost || defaultMariita));
      if(mc === null) return;
      it.mariitaCost = num(mc);

      it.dates.retirado = today;
      it.status = next;
    }

    if(next === "Depositado"){
      // must have been retirado first (enforcement)
      if(it.status !== "Retirado" && it.status !== "Depositado"){
        alert("Para marcar Depositado, primero marca Retirado.");
        return;
      }
      const depDate = prompt("Fecha de dep√≥sito (YYYY-MM-DD):", it.dates.depositado || today);
      if(depDate === null) return;
      it.dates.depositado = depDate;
      it.status = next;
    }

    if(next === "En stock"){
      // reset sale-related fields only if user agrees
      const ok = confirm("¬øVolver a stock? Esto limpiar√° canal/precio/fechas de venta.");
      if(!ok) return;
      it.status = "En stock";
      it.channel = "";
      it.salePrice = 0;
      it.noRetType = "Destino fijo";
      it.mariitaCost = 0;
      it.dates.reserved = "";
      it.dates.noRetirado = "";
      it.dates.reenvio = "";
      it.dates.retirado = "";
      it.dates.depositado = "";
    }

    saveDB(db);
    render();
  }
  window.setStatus = setStatus;

  function renderTable(){
    tbody.innerHTML = "";
    const list = filteredItems();

    if(list.length===0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="5" class="small muted">No hay prendas con esos filtros.</td>`;
      tbody.appendChild(tr);
      return;
    }

    list.forEach(it=>{
      const costs = calcItemCosts(db, it);
      const p = calcProfit(db, it);

      const saleBlock = `
        <div><span class="muted">Canal:</span> <b>${it.channel || "‚Äî"}</b></div>
        <div><span class="muted">Precio:</span> <b>${it.salePrice ? money(it.salePrice) : "‚Äî"}</b></div>
        <div class="small muted">
          Vend: ${fmtDate(it.dates.reserved)} ¬∑ Ret: ${fmtDate(it.dates.retirado)} ¬∑ Dep: ${fmtDate(it.dates.depositado)}
        </div>
      `;

      const costBlock = `
        <div><span class="muted">Costo base:</span> <b>${money(costs.base)}</b> <span class="muted">(incl. aduana)</span></div>
        <div><span class="muted">Mariita:</span> <b>${money(p.mariita)}</b></div>
        <div><span class="muted">No retirado:</span> <b>${money(p.noRetPenalty)}</b> <span class="muted">${it.status==="No retirado" ? "(" + (it.noRetType||"Destino fijo") + ")" : ""}</span></div>
        <div><span class="muted">Costo total:</span> <b>${money(p.totalCost)}</b></div>
        <div><span class="muted">Utilidad:</span> <b>${isSaleReal(it.status) ? money(p.profit) : "‚Äî"}</b>
          <span class="muted">${isSaleReal(it.status) ? "" : "(se confirma al Retirar)"}</span>
        </div>
      `;

      const actions = buildActions(it);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <div><b>${it.type}</b> <span class="muted">(${it.gender}, ${it.condition})</span></div>
          <div class="small muted">${it.sku ? it.sku : ""}</div>
          <div class="small muted">Ingreso: ${fmtDate(it.dates.in)}</div>
        </td>
        <td class="small">${saleBlock}</td>
        <td class="small">${costBlock}</td>
        <td>${pillForStatus(it.status)}</td>
        <td>${actions}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function buildActions(it){
    const btn = (label, cls, next) => `<button class="btn ${cls}" onclick="setStatus('${it.id}','${next}')">${label}</button>`;
    const wrap = (inner) => `<div class="flex">${inner}</div>`;

    if(it.status==="En stock"){
      return wrap(btn("Marcar vendido", "warn", "Reservado/Vendido"));
    }
    if(it.status==="Reservado/Vendido"){
      return wrap(
        btn("No retirado", "bad", "No retirado") +
        btn("Retirado", "ok", "Retirado") +
        btn("Volver stock", "info", "En stock")
      );
    }
    if(it.status==="No retirado"){
      return wrap(
        btn("Reenv√≠o", "warn", "Reenv√≠o") +
        btn("Volver stock", "info", "En stock")
      );
    }
    if(it.status==="Reenv√≠o"){
      return wrap(
        btn("Retirado", "ok", "Retirado") +
        btn("No retirado", "bad", "No retirado")
      );
    }
    if(it.status==="Retirado"){
      return wrap(
        btn("Depositado", "ok", "Depositado")
      );
    }
    if(it.status==="Depositado"){
      return wrap(
        btn("Volver a Retirado", "warn", "Retirado")
      );
    }
    return wrap(btn("Volver stock", "info", "En stock"));
  }

  filterStatus.addEventListener("input", renderTable);
  filterChannel.addEventListener("input", renderTable);
  search.addEventListener("input", renderTable);

  function render(){
    renderTips();
    renderRecon();
    renderTable();
  }

  render();
</script>
</body>
</html>
